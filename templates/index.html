<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
</head>
<body>
    <div class="container">
        <h1 class="title">üå§Ô∏è Weather App</h1>
        
        <form id="weatherForm" method="POST" action="{{ url_for('index') }}">
            <div class="form-row">
                <div class="form-group flex-1">
                    <label for="location">South African City *</label>
                    <div class="autocomplete-container">
                        <input type="text" id="location" name="cityN" placeholder="Start typing city name..." required 
                               value="{{ request.form.cityN if request.form else '' }}" autocomplete="off">
                        <div class="autocomplete-suggestions" id="suggestions"></div>
                    </div>
                </div>
                <div class="form-group flex-1">
                    <label for="state">Province (Optional)</label>
                    <input type="text" id="state" name="stateN" placeholder="Enter province" 
                           value="{{ request.form.stateN if request.form else '' }}">
                </div>
            </div>
            
            <div class="form-group">
                <label for="country">Country *</label>
                <select id="country" name="countryN" required>
                    <option value="">Select a country</option>
                    <option value="US" {{ 'selected' if request.form and request.form.countryN == 'US' else '' }}>United States</option>
                    <option value="GB" {{ 'selected' if request.form and request.form.countryN == 'GB' else '' }}>United Kingdom</option>
                    <option value="CA" {{ 'selected' if request.form and request.form.countryN == 'CA' else '' }}>Canada</option>
                    <option value="AU" {{ 'selected' if request.form and request.form.countryN == 'AU' else '' }}>Australia</option>
                    <option value="DE" {{ 'selected' if request.form and request.form.countryN == 'DE' else '' }}>Germany</option>
                    <option value="FR" {{ 'selected' if request.form and request.form.countryN == 'FR' else '' }}>France</option>
                    <option value="IT" {{ 'selected' if request.form and request.form.countryN == 'IT' else '' }}>Italy</option>
                    <option value="ES" {{ 'selected' if request.form and request.form.countryN == 'ES' else '' }}>Spain</option>
                    <option value="JP" {{ 'selected' if request.form and request.form.countryN == 'JP' else '' }}>Japan</option>
                    <option value="CN" {{ 'selected' if request.form and request.form.countryN == 'CN' else '' }}>China</option>
                    <option value="IN" {{ 'selected' if request.form and request.form.countryN == 'IN' else '' }}>India</option>
                    <option value="BR" {{ 'selected' if request.form and request.form.countryN == 'BR' else '' }}>Brazil</option>
                    <option value="ZA" {{ 'selected' if request.form and request.form.countryN == 'ZA' else '' }}>South Africa</option>
                    <option value="NG" {{ 'selected' if request.form and request.form.countryN == 'NG' else '' }}>Nigeria</option>
                    <option value="EG" {{ 'selected' if request.form and request.form.countryN == 'EG' else '' }}>Egypt</option>
                    <option value="MX" {{ 'selected' if request.form and request.form.countryN == 'MX' else '' }}>Mexico</option>
                    <option value="AR" {{ 'selected' if request.form and request.form.countryN == 'AR' else '' }}>Argentina</option>
                    <option value="RU" {{ 'selected' if request.form and request.form.countryN == 'RU' else '' }}>Russia</option>
                    <option value="KR" {{ 'selected' if request.form and request.form.countryN == 'KR' else '' }}>South Korea</option>
                    <option value="TH" {{ 'selected' if request.form and request.form.countryN == 'TH' else '' }}>Thailand</option>
                </select>
            </div>
            
            <button type="submit" class="search-btn">Get Weather</button>
        </form>

        {% if error_message %}
        <div class="error-message" style="display: block;">
            {{ error_message }}
        </div>
        {% endif %}

        {% if data %}
        <div class="weather-result" style="display: block;">
            <div class="weather-header">
                <div class="location-name">{{ request.form.cityN }}{% if request.form.stateN %}, {{ request.form.stateN }}{% endif %}{% if request.form.countryN %}, {{ request.form.countryN }}{% endif %}</div>
            </div>
            
            <div class="weather-main">
                <img class="weather-icon" 
                     src="https://openweathermap.org/img/wn/{{ data.icon }}@2x.png" 
                     alt="{{ data.description }}">
                <div class="temperature">{{ data.temperature|round|int }}¬∞C</div>
            </div>
            
            <div class="weather-desc">{{ data.description|title }}</div>
            
            <div class="weather-details">
                <div class="detail-item">
                    <div class="detail-label">Main</div>
                    <div class="detail-value">{{ data.main }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Temperature</div>
                    <div class="detail-value">{{ data.temperature|round(1) }}¬∞C</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Description</div>
                    <div class="detail-value">{{ data.description|title }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Weather Icon</div>
                    <div class="detail-value">{{ data.icon }}</div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        const cityInput = document.getElementById('location');
        const stateInput = document.getElementById('state');
        const countrySelect = document.getElementById('country');
        const suggestionsDiv = document.getElementById('suggestions');
        
        let debounceTimer;
        let selectedIndex = -1;
        let suggestions = [];
        
        // Get API key from backend
        const API_KEY = '28f923f1ae5e46175031794716fa4cb0';
        
        cityInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            clearTimeout(debounceTimer);
            
            if (query.length < 2) {
                suggestionsDiv.classList.remove('active');
                return;
            }
            
            suggestionsDiv.innerHTML = '<div class="loading-suggestions">Searching...</div>';
            suggestionsDiv.classList.add('active');
            
            debounceTimer = setTimeout(() => {
                fetchCitySuggestions(query);
            }, 300);
        });
        
        async function fetchCitySuggestions(query) {
            try {
                const response = await fetch(
                    `https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(query)},ZA&limit=10&appid=${API_KEY}`
                );
                const data = await response.json();
                
                // Filter to only South African cities
                const southAfricanCities = data.filter(city => city.country === 'ZA');
                
                if (southAfricanCities.length === 0) {
                    suggestionsDiv.innerHTML = '<div class="loading-suggestions">No South African cities found</div>';
                    return;
                }
                
                suggestions = southAfricanCities;
                displaySuggestions(southAfricanCities);
            } catch (error) {
                console.error('Error fetching suggestions:', error);
                suggestionsDiv.innerHTML = '<div class="loading-suggestions">Error loading suggestions</div>';
            }
        }
        
        function displaySuggestions(cities) {
            suggestionsDiv.innerHTML = '';
            selectedIndex = -1;
            
            cities.forEach((city, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.innerHTML = `
                    <div class="city-name">${city.name}</div>
                    <div class="city-details">${city.state ? city.state + ', ' : ''}${city.country}</div>
                `;
                
                div.addEventListener('click', () => {
                    selectCity(city);
                });
                
                suggestionsDiv.appendChild(div);
            });
        }
        
        function selectCity(city) {
            cityInput.value = city.name;
            if (city.state) {
                stateInput.value = city.state;
            }
            
            // Automatically set country to South Africa
            const countryOptions = countrySelect.options;
            for (let i = 0; i < countryOptions.length; i++) {
                if (countryOptions[i].value === 'ZA') {
                    countrySelect.selectedIndex = i;
                    break;
                }
            }
            
            suggestionsDiv.classList.remove('active');
            selectedIndex = -1;
        }
        
        // Keyboard navigation
        cityInput.addEventListener('keydown', function(e) {
            const items = suggestionsDiv.querySelectorAll('.autocomplete-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection(items);
            } else if (e.key === 'Enter' && selectedIndex >= 0) {
                e.preventDefault();
                selectCity(suggestions[selectedIndex]);
            } else if (e.key === 'Escape') {
                suggestionsDiv.classList.remove('active');
                selectedIndex = -1;
            }
        });
        
        function updateSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        
        // Close suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!cityInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                suggestionsDiv.classList.remove('active');
            }
        });
    </script>
</body>
</html>